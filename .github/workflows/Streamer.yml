name: Streamer

on:
  workflow_dispatch:
    inputs:
      file_name:
        description: 'Swift file to build'
        required: true

jobs:
  build-and-deploy:
    runs-on: macos-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Create SwiftUI App Project
        run: |
          mkdir -p BuildApp
          
          # Read the uploaded file and remove @main app struct if present
          if [ -f "Sources/${{ github.event.inputs.file_name }}" ]; then
            # Remove @main, the App struct, and keep only the views
            sed -E '/@main/d; /struct.*App.*\{/,/^struct|^$|^\/\//{ /WindowGroup|Scene|var body: some Scene/d; }' \
              "Sources/${{ github.event.inputs.file_name }}" > BuildApp/ContentView.swift
            
            # If sed didn't work well, use a smarter approach with awk
            cat "Sources/${{ github.event.inputs.file_name }}" | awk '
              /@main/ { skip=1; next }
              /struct [A-Za-z]+App.*:.*App/ { skip=1; brace=1; next }
              skip && /{/ { brace++ }
              skip && /}/ { brace--; if(brace<=0) { skip=0 }; next }
              !skip { print }
            ' > BuildApp/ContentView.swift
            
            echo "=== Processed ContentView.swift ==="
            cat BuildApp/ContentView.swift
            echo "==================================="
          else
            echo "Source file not found!"
            exit 1
          fi
          
          # Create App entry point
          cat > BuildApp/App.swift << 'SWIFT'
          import SwiftUI
          
          @main
          struct BuildAppApp: App {
              var body: some Scene {
                  WindowGroup {
                      ContentView()
                  }
              }
          }
          SWIFT
          
          # Create Info.plist
          cat > BuildApp/Info.plist << 'PLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleDevelopmentRegion</key>
              <string>en</string>
              <key>CFBundleExecutable</key>
              <string>BuildApp</string>
              <key>CFBundleIdentifier</key>
              <string>com.swiftide.buildapp</string>
              <key>CFBundleInfoDictionaryVersion</key>
              <string>6.0</string>
              <key>CFBundleName</key>
              <string>BuildApp</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>CFBundleShortVersionString</key>
              <string>1.0</string>
              <key>CFBundleVersion</key>
              <string>1</string>
              <key>LSRequiresIPhoneOS</key>
              <true/>
              <key>UILaunchScreen</key>
              <dict/>
              <key>UIRequiredDeviceCapabilities</key>
              <array>
                  <string>arm64</string>
              </array>
              <key>UISupportedInterfaceOrientations</key>
              <array>
                  <string>UIInterfaceOrientationPortrait</string>
                  <string>UIInterfaceOrientationLandscapeLeft</string>
                  <string>UIInterfaceOrientationLandscapeRight</string>
              </array>
          </dict>
          </plist>
          PLIST

      - name: Build for iOS Simulator
        run: |
          cd BuildApp
          
          # Find iOS Simulator SDK
          SDK_PATH=$(xcrun --sdk iphonesimulator --show-sdk-path)
          echo "Using SDK: $SDK_PATH"
          
          # Get the target triple for simulator
          ARCH="arm64"
          TARGET="${ARCH}-apple-ios16.0-simulator"
          
          echo "Building for target: $TARGET"
          
          # Compile with proper flags for iOS Simulator
          xcrun swiftc \
            -sdk "$SDK_PATH" \
            -target "$TARGET" \
            -parse-as-library \
            -emit-executable \
            -o BuildApp \
            App.swift \
            ContentView.swift
          
          echo "Build successful!"
          ls -la BuildApp
            
      - name: Create .app bundle
        run: |
          mkdir -p BuildApp.app
          mv BuildApp/BuildApp BuildApp.app/BuildApp
          cp BuildApp/Info.plist BuildApp.app/Info.plist
          
          echo "=== App bundle contents ==="
          ls -la BuildApp.app/
          
      - name: Upload to Appetize
        env:
          APPETIZE_TOKEN: ${{ secrets.APPETIZE_TOKEN }}
        run: |
          # Zip the app bundle
          zip -r app.zip BuildApp.app
          
          echo "Uploading to Appetize.io..."
          
          # Upload to Appetize (update existing app)
          RESPONSE=$(curl -s -X POST \
            --http1.1 \
            -H "Authorization: $APPETIZE_TOKEN" \
            -F "file=@app.zip" \
            -F "platform=ios" \
            "https://api.appetize.io/v2/apps/zvc4brtsspoktczlbrs54s3mhi")
          
          echo "Appetize Response:"
          echo "$RESPONSE"
          
          # Check if upload was successful
          if echo "$RESPONSE" | grep -q "publicKey"; then
            echo "✅ Upload successful!"
          else
            echo "❌ Upload may have failed"
            exit 1
          fi
