name: Streamer

on:
  workflow_dispatch:
    inputs:
      file_name:
        description: 'Swift file to build'
        required: true
        type: string

jobs:
  build-and-deploy:
    runs-on: macos-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install XcodeGen
        run: brew install xcodegen
      
      - name: Create Project Files
        run: |
          mkdir -p MyApp/Sources
          
          # Process uploaded file
          if [ -f "Sources/${{ github.event.inputs.file_name }}" ]; then
            cat "Sources/${{ github.event.inputs.file_name }}" | awk '
              /@main/ { skip=1; next }
              /struct [A-Za-z]+App.*:.*App/ { skip=1; brace=1; next }
              skip && /{/ { brace++ }
              skip && /}/ { brace--; if(brace<=0) { skip=0 }; next }
              !skip { print }
            ' > MyApp/Sources/ContentView.swift
            
            echo "=== ContentView.swift ==="
            cat MyApp/Sources/ContentView.swift
          else
            cat > MyApp/Sources/ContentView.swift << 'SWIFT'
          import SwiftUI
          struct ContentView: View {
              var body: some View {
                  Text("Hello World")
              }
          }
          SWIFT
          fi
          
          # Create App entry point
          cat > MyApp/Sources/MyAppApp.swift << 'SWIFT'
          import SwiftUI
          
          @main
          struct MyAppApp: App {
              var body: some Scene {
                  WindowGroup {
                      ContentView()
                  }
              }
          }
          SWIFT
          
          # Create Assets folder
          mkdir -p MyApp/Sources/Assets.xcassets
          echo '{"info":{"version":1,"author":"xcode"}}' > MyApp/Sources/Assets.xcassets/Contents.json
          
          # Create XcodeGen spec
          cat > MyApp/project.yml << 'YAML'
          name: MyApp
          options:
            bundleIdPrefix: com.swiftide
            deploymentTarget:
              iOS: "16.0"
          
          targets:
            MyApp:
              type: application
              platform: iOS
              sources:
                - Sources
              settings:
                base:
                  PRODUCT_BUNDLE_IDENTIFIER: com.swiftide.myapp
                  MARKETING_VERSION: "1.0"
                  CURRENT_PROJECT_VERSION: "1"
                  CODE_SIGN_IDENTITY: ""
                  CODE_SIGNING_REQUIRED: "NO"
                  CODE_SIGNING_ALLOWED: "NO"
                  INFOPLIST_KEY_UILaunchScreen_Generation: "YES"
                  INFOPLIST_KEY_UIApplicationSceneManifest_Generation: "YES"
                  GENERATE_INFOPLIST_FILE: "YES"
                  SWIFT_VERSION: "5.0"
          YAML
          
          echo "=== project.yml ==="
          cat MyApp/project.yml

      - name: Generate Xcode Project
        run: |
          cd MyApp
          xcodegen generate
          echo "Project generated!"
          ls -la
          ls -la MyApp.xcodeproj/

      - name: Build for Simulator
        run: |
          cd MyApp
          
          # List available schemes
          xcodebuild -list -project MyApp.xcodeproj
          
          # Build
          xcodebuild \
            -project MyApp.xcodeproj \
            -scheme MyApp \
            -sdk iphonesimulator \
            -configuration Debug \
            -derivedDataPath build \
            -arch arm64 \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            build
          
          echo "Build complete!"
          find build -name "*.app" -type d

      - name: Upload to Appetize
        env:
          APPETIZE_TOKEN: ${{ secrets.APPETIZE_TOKEN }}
        run: |
          APP_PATH=$(find MyApp/build -name "*.app" -type d | head -1)
          echo "Found app: $APP_PATH"
          
          if [ -z "$APP_PATH" ]; then
            echo "No .app found!"
            exit 1
          fi
          
          # Show app contents
          ls -la "$APP_PATH"
          
          # Zip from inside the .app directory for correct structure
          cd "$APP_PATH"
          zip -r ../../../app.zip .
          cd ../../..
          
          echo "Uploading to Appetize..."
          RESPONSE=$(curl -s "https://api.appetize.io/v1/apps/zvc4brtsspoktczlbrs54s3mhi?token=$APPETIZE_TOKEN" \
            -F "file=@app.zip" \
            -F "platform=ios")
          
          echo "Response:"
          echo "$RESPONSE"
          
          if echo "$RESPONSE" | grep -q "publicKey"; then
            echo "âœ… Upload successful!"
          else
            echo "Creating new app..."
            RESPONSE2=$(curl -s "https://api.appetize.io/v1/apps?token=$APPETIZE_TOKEN" \
              -F "file=@app.zip" \
              -F "platform=ios")
            echo "$RESPONSE2"
          fi
