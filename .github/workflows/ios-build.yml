name: iOS Build
on:
  workflow_dispatch:
    inputs:
      ref:
        default: "main"
jobs:
  build:
    permissions: write-all
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Install XcodeGen
        run: brew install xcodegen
        
      - name: Generate Project
        run: xcodegen generate
        
      - name: Get Project Name
        id: project
        run: |
          PROJECT_NAME=$(grep "^name:" project.yml | head -1 | sed 's/name: *//')
          echo "name=$PROJECT_NAME" >> $GITHUB_OUTPUT
          
      - name: Build Archive
        run: |
          xcodebuild archive \
            -project "${{ steps.project.outputs.name }}.xcodeproj" \
            -scheme "${{ steps.project.outputs.name }}" \
            -destination "generic/platform=iOS" \
            -archivePath "build/${{ steps.project.outputs.name }}.xcarchive" \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO
            
      - name: Export IPA (Unsigned)
        run: |
          mkdir -p Payload
          cp -r "build/${{ steps.project.outputs.name }}.xcarchive/Products/Applications/${{ steps.project.outputs.name }}.app" Payload/
          zip -r "${{ steps.project.outputs.name }}.ipa" Payload
          
      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ github.run_id }}
          files: ${{ steps.project.outputs.name }}.ipa
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
